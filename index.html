<!DOCTYPE html>
<html lang="en,es">

<head>
    <link rel="icon" href="./favicon.ico">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Karla&family=Roboto&display=swap" rel="stylesheet">
    <title>Diax - Ayuda</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        html,
        body {
            background-color: white;
            color: black;
            padding: 0px;
            margin: 0px;
            min-width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-family: 'Karla', sans-serif;
        }

        .columns {
            display: flex;
            flex-direction: row;
        }

        .rows {
            display: flex;
            flex-direction: column;
        }

        .center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .left {
            display: flex;
            justify-content: flex-start;
        }

        .noselect {
            -webkit-touch-callout: none;
            /* iOS Safari */
            -webkit-user-select: none;
            /* Safari */
            -khtml-user-select: none;
            /* Konqueror HTML */
            -moz-user-select: none;
            /* Old versions of Firefox */
            -ms-user-select: none;
            /* Internet Explorer/Edge */
            user-select: none;
            /* Non-prefixed version, currently supported by Chrome, Edge, Opera and Firefox */
        }

        #ayuda {
            min-width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
        }

        h1 {
            color: white;
            margin: 10px;
            padding: 0px;
            width: fit-content;
            height: fit-content;
            position: absolute;
        }

        h2 {
            color: #203461;
            font-size: 14px;
            margin: 0px;
            padding: 0px;
            width: fit-content;
            height: fit-content;
            margin-bottom: 5px;
            margin-top: 20px;
            padding: 0px;

        }

        #prioridad_row>div>h2 {
            margin: auto;

        }

        #espacio_slide {
            width: 100%;
            height: 100%;
        }

        #prioridad_row {
            margin-top: 20px;
            display: flex;
        }

        .descripciones {
            color: #203461;
            font-size: 18px;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        #titulo_row {
            background-image: url("./header.jpg");
            background-repeat: no-repeat;
            background-position: 50% calc(10% - 100px);
            background-size: cover;
            min-height: 100px;
            min-width: 100%;
            position: relative;

        }

        #opacidad_row {
            opacity: 0.6;
            background-color: #2857ce;
            height: 100%;
            width: 100%;
            position: absolute;

        }

        #contenedor_rows {
            max-width: 300px;
            min-width: 300px;
            height: fit-content;
            display: none;
        }

        #error {}

        select {
            width: 100%;
            border-color: #203461;
            color: #203461;
            height: 30px;
            font-family: 'Karla', sans-serif;
        }

        input[type=text] {
            border-color: #203461;
            color: #203461;
            border-width: 1px;
            height: 23px;
            width: auto;
            font-family: 'Karla', sans-serif;
            padding: 3px;
            padding-left: 5px;

        }

        textarea {

            border-color: #203461;
            color: #203461;
            width: 100%;
            box-sizing: border-box;
            margin:0px;
            height: 100px;
            resize: vertical;
            font-family: 'Karla', sans-serif;
            padding: 5px;

        }
        #descripcion_row {
            width: 100%;
        }

        .refresh {
            border: 1px solid #203461;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            color: #203461;
            right:-10px;
            transform: translate(100%);
            position: absolute;
            cursor: pointer;
            font-size: auto;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;

        }
        .refresh:hover {
            transform: scale(1.1) translate(100%);
        }

        .refresh:active {
            transform: scale(0.9)  translate(100%);
        }

        #submit:hover {
            transform: scale(1.1);
        }

        #submit:active {
            transform: scale(0.9);
        }

        #submit {
            border: 1px solid;
            width: 120px;
            height: 30px;
            margin: 20px;
            background-color: #0066fe;
            color: white;
            cursor: pointer;
            font-size: auto;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .row_space {
            margin-top: 20px;
        }

        #logo {
            margin: 20px;
        }
        .relative {
            position: relative;
        }
    </style>

</head>

<body class="noselect">
    <div id="ayuda" class="rows">
        <div id="logo_row">
            <img src="./logo.png" alt="Logo Diax" id="logo" />
        </div>
        <div id="titulo_row" class="center">
            <div id="opacidad_row"></div>
            <h1>Centro de Ayuda</h1>
        </div>
        <div id="error" class="descripciones">
            <text>Error de conección a la API. Contáctate con soporte.</text>
        </div>
        <div id="contenedor_rows">
            <div id="instrucciones" class="descripciones">
                <text>Ingresa tu nombre junto con el equipo que deseas crear la petición.</text>

            </div>
            <div id="empleado_row" class="rows">
                <div>
                    <h2>Empleado:</h2>
                </div>
                <div class="columns center left relative">
                    <select id="employee_id">
                        <option value="">Nombre</option>
                    </select>
                    <div class="refresh">
                        <text>&#x21bb;</text>
                    </div>
                </div>
            </div>
            <div id="equipo_row" class="rows">
                <div>
                    <h2>Equipo:</h2>
                </div>
                <div class="columns center left relative">
                    <select id="equipment_id">
                        <option value="">Equipo</option>
                    </select>
                    <div class="refresh">
                        <text>&#x21bb;</text>
                    </div>
                </div>
            </div>
            <div id="prioridad_row" class="columns center left">
                <div>
                    <h2>Prioridad:</h2>
                </div>
                <div id="espacio_slide">
                    <input type="range" min="1" max="3" value="1" id="priority">
                </div>
            </div>
            <div id="tema_row" class="rows left">
                <div>
                    <h2>Titulo:</h2>
                </div>
                <input type="text" id="name" placeholder="Asunto">
            </div>
            <div id="descripcion_row">
                <div>
                    <h2>Descripción:</h2>
                </div>
                <textarea id="description" class="left" placeholder="Escribe el problema..."></textarea>
            </div>
            <div id="submit_row" class="center">
                <div id="submit">
                    <text>Enviar</text>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function getMaintenance() {
            try {
                const response = await fetch("https://api.diax.com.co/getodoomaintenanceinfo", {
                    method: "GET",
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                    }
                });
                const myJson = await response.json();
                if (response.status != 200) {

                    $("#error").show();
                    $("#contenedor_rows").hide();
                    alert("Error0 (Error de coneccion con la API): " + myJson);
                } else {
                    _mantenimiento = JSON.parse(myJson.body);
                    localStorage.setItem('_mantenimiento', JSON.stringify(_mantenimiento));
                    enablePage();
                }
            } catch (e) {
                $("#error").show();
                $("#contenedor_rows").hide();
                alert("Error1: " + e);
            }
        }

        try {
            var _mantenimiento = JSON.parse(localStorage.getItem('_mantenimiento'));
        } catch (e) {
            localStorage.setItem('_mantenimiento', "");
            var _mantenimiento = {};
        }
        if (_mantenimiento == null)
            getMaintenance();
        else
            enablePage();

        var trys = 0;

        function enablePage() {
            try {
                _mantenimiento.employees.forEach(element => {
                    $('#employee_id').append($('<option>', {
                        value: element.id,
                        text: element.resource_id[1]
                    }));
                });
                _mantenimiento.equipment.forEach(element => {
                    $('#equipment_id').append($('<option>', {
                        value: element.id,
                        text: element.name
                    }));
                });
                $("#error").hide();
                $("#contenedor_rows").show();
            } catch (e) {
                if (trys == 0) {
                    trys++;
                    getMaintenance();
                } else {
                    $("#error").show();
                    $("#contenedor_rows").hide();
                    alert("Error2: " + e);
                }
            }
        }

        $("#refresh").click(function (e) {

            $('#employee_id').empty();
            $('#equipment_id').empty();
            $('#employee_id').append($('<option>', {
                value: "",
                text: "Empleado"
            }));
            $('#equipment_id').append($('<option>', {
                value: "",
                text: "Equipo"
            }));

            localStorage.setItem('_mantenimiento', "");
            var _mantenimiento = {};
            getMaintenance();
        });

        $("#submit").click(function (e) {
            e.preventDefault(); //stop the browser from following

            $("#name").prop("disabled", true);
            $("#description").prop("disabled", true);
            $("#priority").prop("disabled", true);
            $("#equipment_id").prop("disabled", true);
            $("#employee_id").prop("disabled", true);
            $("#submit").hide();

            function reenable() {

                $("#name").prop("disabled", false);
                $("#description").prop("disabled", false);
                $("#priority").prop("disabled", false);
                $("#equipment_id").prop("disabled", false);
                $("#employee_id").prop("disabled", false);
                $("#submit").show();
            }
            var team = 2;
            _mantenimiento.equipment.forEach(element => {
                if (element.id == $('#equipment_id').val()) {
                    if (element.category_id[0] == "8") {
                        team = 3;
                    }
                    return;
                }
            });
            try {
                if (
                    $("#priority").val() == "" ||
                    $("#priority").val() == null ||
                    $("#employee_id").val() == "" ||
                    $("#employee_id").val() == null ||
                    $("#equipment_id").val() == "" ||
                    $("#equipment_id").val() == null
                ) {
                    alert("Faltan campos por llenar");
                    reenable();
                    return;
                }
                var _name = $("#name").val()
                if (
                    _name == "" ||
                    _name == null) {
                        _name = "Petición API";
                }

                var d = new Date();
                var datestring = d.getFullYear() + "-" + ("0" + (d.getMonth() + 1)).slice(-2) + "-" + ("0" + d
                        .getDate()).slice(-2) +
                    " " + ("0" + d.getHours()).slice(-2) + ":" + ("0" + d.getMinutes()).slice(-2) + ":00";
                var _form = {
                    "name": $("#name").val(),
                    "description": $("#description").val(),
                    "priority": $("#priority").val(),
                    "schedule_date": datestring,
                    "maintenance_type": "corrective",
                    "employee_id": parseInt($("#employee_id").val()),
                    "equipment_id": parseInt($("#equipment_id").val()),
                    "maintenance_team_id": team
                };
                async function subscribe(_res) {
                    try {
                        const response = await fetch(
                            "https://api.diax.com.co/createodoomaintenancerequest", {
                                method: "POST",
                                headers: {},
                                body: JSON.stringify(_res)
                            });

                        const myJson = await response.json(); //extract JSON from the http response
                        // do something with myJson
                        if (myJson.statusCode != 200) {
                            $("#error").show();
                            $("#contenedor_rows").hide();
                            alert("Error3 (Error de conexión con la API): " + myJson["body"]);
                        } else {
                            $("#name").val("Petición API")
                            $("#description").val("Petición de Ayuda")
                            $("#priority").val("1")
                            $("#employee_id").val("")
                            $("#equipment_id").val("")
                            alert("Tiquete creado exitosamente: " + myJson["body"]);
                            reenable();
                        }
                    } catch (e) {
                        $("#error").show();
                        $("#contenedor_rows").hide();
                        alert("Error4: " + e);
                    }
                }
                subscribe(_form);
            } catch (e) {
                $("#error").show();
                $("#contenedor_rows").hide();
                alert("Error5: " + e);
            }
        });
    </script>
</body>

</html>